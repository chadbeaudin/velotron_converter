name: Build and publish Docker image

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'

      # Check whether this repo contains Go modules (go.mod / go.sum)
      - name: Check for Go modules
        id: has_go
        run: |
          if [ -f go.mod ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      # Only attempt to cache/restore Go modules if go.mod exists
      - name: Cache Go modules
        if: steps.has_go.outputs.found == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run tests
        run: |
          set -e
          if [ -f package.json ]; then
            npm ci
            npm test
          elif [ -f pyproject.toml ] || [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
            pytest
          elif [ -f go.mod ]; then
            go test ./...
          else
            echo "No recognized test files; skipping tests"
          fi

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for semantic-version to access git history

      - name: Calculate Semantic Version
        id: version
        uses: paulhatch/semantic-version@v5.4.0
        with:
          tag_prefix: "v"
          major_pattern: "(MAJOR)"
          minor_pattern: "(feat)"
          version_format: "${major}.${minor}.${patch}"
          user_last_commit: true
          
      - name: Tag Repository
        if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag v${{ steps.version.outputs.version }}
          git push origin v${{ steps.version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.ref == 'refs/heads/master' && github.event_name != 'pull_request' }}
          platforms: linux/amd64,linux/arm64
          tags: |
            docker.io/bigtimber/velotron-converter:latest
            docker.io/bigtimber/velotron-converter:v${{ steps.version.outputs.version }}
          build-args: |
            TZ=America/Denver
            LOGO_FILE=logo.png
            VERSION=v${{ steps.version.outputs.version }}

      - name: Image info
        if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'
        run: docker manifest inspect docker.io/bigtimber/velotron-converter:latest || true

